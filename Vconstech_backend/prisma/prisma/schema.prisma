generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  name               String
  email              String              @unique
  password           String
  phoneNumber        String              // ✅ ADD THIS LINE
  city               String              // ✅ ADD THIS LINE
  address            String              // ✅ ADD THIS LINE
  companyId          String?
  package            String?             // ✅ ADD THIS LINE - "Classic", "Pro", or "Premium"
  customMembers      Int? 
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  role               String
  uploadedFiles      File[]
  createdBills Bill[]
  projectAssignments ProjectAssignment[]
  company            Company?            @relation(fields: [companyId], references: [id])

  @@index([phoneNumber])
}

model daily_progress_updates {
  id          Int      @id @default(autoincrement())
  projectId   Int
  engineerId  Int
  message     String   @db.Text
  workDone    String?  @db.Text
  challenges  String?  @db.Text
  nextSteps   String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  engineer    Engineer @relation(fields: [engineerId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([engineerId])
  @@index([createdAt])
  @@map("daily_progress_updates")
}

model Project {
  id                 Int                    @id @default(autoincrement())
  name               String
  description        String?
  companyId          String
  startDate          DateTime?
  endDate            DateTime?
  dueDate            DateTime?
  status             ProjectStatus          @default(ONGOING)
  createdAt          DateTime               @default(now())
  budget             Float?
  quotationAmount    Float?
  clientName         String
  projectId          String                 @unique
  projectType        String
  location           String?
  assignedEngineerId Int?
  actualProgress     Int                    @default(0) // ✅ NEW: Actual progress percentage (0-100)
  contracts          Contract[]
  files              File[]
  expenses           ProjectExpense[]
  finances           FinancialTransaction[]
  materialUsages     MaterialUsage[]
  projectMaterials   ProjectMaterial[]
  materialRequests   MaterialRequest[]
  labours            Labour[]
  bills     Bill[] 
  company            Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignments        ProjectAssignment[]
  dailyUpdates       daily_progress_updates[]
  assignedEngineer   Engineer?              @relation(fields: [assignedEngineerId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([projectId])
  @@index([status])
  @@index([assignedEngineerId])
}

model ProjectExpense {
  id        Int      @id @default(autoincrement())
  projectId Int
  category  String
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
}

model ProjectAssignment {
  id         Int      @id @default(autoincrement())
  projectId  Int
  userId     String
  assignedAt DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Material {
  id               Int               @id @default(autoincrement())
  materialId       String            @unique
  name             String
  category         String
  type             String?
  unit             String
  defaultRate      Float?
  vendor           String?
  description      String?
  companyId        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usages           MaterialUsage[]
  projectMaterials ProjectMaterial[]
  requests         MaterialRequest[]

  @@index([companyId])
  @@index([materialId])
  @@index([category])
}

model ProjectMaterial {
  id         Int                   @id @default(autoincrement())
  projectId  Int
  materialId Int
  assigned   Float
  used       Float                 @default(0)
  status     ProjectMaterialStatus @default(ACTIVE)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  project    Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material   Material              @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([projectId, materialId])
  @@index([projectId])
  @@index([materialId])
  @@index([status])
}

model MaterialUsage {
  id         Int      @id @default(autoincrement())
  materialId Int
  projectId  Int
  engineerId Int
  quantity   Float
  remarks    String?
  date       DateTime @default(now())
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  engineer   Engineer @relation(fields: [engineerId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([materialId])
  @@index([engineerId])
  @@index([date])
}

model MaterialRequest {
  id              Int                 @id @default(autoincrement())
  requestId       String              @unique
  employeeId      Int
  name            String
  category        String
  unit            String
  defaultRate     Float
  vendor          String?
  description     String?
  type            MaterialRequestType
  projectId       Int?
  materialId      Int?
  quantity        Float?
  status          RequestStatus       @default(PENDING)
  requestDate     DateTime            @default(now())
  reviewDate      DateTime?
  approvalNotes   String?
  rejectionReason String?
  reviewedBy      Int?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  employee        Engineer            @relation("EmployeeRequests", fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer        Engineer?           @relation("ReviewedRequests", fields: [reviewedBy], references: [id], onDelete: SetNull)
  project         Project?            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material        Material?           @relation(fields: [materialId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([status])
  @@index([type])
  @@index([projectId])
  @@index([requestDate])
}

model Notification {
  id         Int              @id @default(autoincrement())
  engineerId Int
  message    String
  type       NotificationType
  read       Boolean          @default(false)
  date       DateTime         @default(now())
  engineer   Engineer         @relation(fields: [engineerId], references: [id], onDelete: Cascade)

  @@index([engineerId])
  @@index([read])
  @@index([date])
}

model Contract {
  id             Int      @id @default(autoincrement())
  projectId      Int
  contractorName String
  contactNumber  String
  contractAmount Float
  paidAmount     Float    @default(0)  // ✅ ADD THIS
  workStatus     String
  details        String?
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt 
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
}

model FinancialTransaction {
  id          Int             @id @default(autoincrement())
  projectId   Int
  type        TransactionType
  category    String?
  amount      Float
  description String?
  date        DateTime        @default(now())
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([category])
  @@index([date])
}

model File {
  id                   Int      @id @default(autoincrement())
  projectId            Int
  uploadedBy           String?  
  uploadedByEngineerId Int?     
  fileUrl              String
  fileName             String?
  documentType         String?
  fileSize             Int?
  uploadedAt           DateTime @default(now())
  project              Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                 User?     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  engineer             Engineer? @relation(fields: [uploadedByEngineerId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
  @@index([uploadedByEngineerId])
}

model Company {
  id        String     @id @default(uuid())
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  materials Material[]
  projects  Project[]
  users     User[]
  engineers Engineer[]
  labours   Labour[]   // ✅ ADDED
bills     Bill[] 

  @@map("companies")
}

model Engineer {
  id               Int               @id @default(autoincrement())
  name             String
  empId            String
  phone            String
  alternatePhone   String?
  address          String
  profileImage     String?
  username         String?
  password         String?
  companyId        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects         Project[]
  materialRequests MaterialRequest[] @relation("EmployeeRequests")
  reviewedRequests MaterialRequest[] @relation("ReviewedRequests")
  notifications    Notification[]
  materialUsages   MaterialUsage[]
  uploadedFiles    File[]
  dailyUpdates     daily_progress_updates[]

  @@unique([empId, companyId])
  @@unique([username, companyId])
  @@index([companyId])
  @@index([username])
  @@map("engineers")
}

// ✅ NEW: Labour Management Models
model Labour {
  id        Int              @id @default(autoincrement())
  name      String
  phone     String
  address   String?
  companyId String
  projectId Int?             // Optional: link to specific project
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  payments  LabourPayment[]
  
  @@index([companyId])
  @@index([projectId])
  @@index([phone])
}

model Bill {
  id        Int      @id @default(autoincrement())
  billId    String   @unique // Bill Number like "INV-001"
  
  // Bill Information
  billDate  DateTime
  dueDate   DateTime?
  
  // Company Information (Billing From)
  companyName    String?
  companyAddress String?
  companyGST     String?
  companyPhone   String?
  companyEmail   String?
  
  // Client Information (Billing To)
  clientName    String
  clientAddress String?
  clientGST     String?
  clientPhone   String?
  clientEmail   String?
  
  // Project Information
  projectId      Int?
  projectName    String
  projectLocation String?
  workOrderNo    String?
  
  // Additional Charges
  labourCharges            Float @default(0)
  transportCharges         Float @default(0)
  otherCharges             Float @default(0)
  otherChargesDescription  String?
  
  // Tax Percentages
  cgstPercent      Float @default(9)
  sgstPercent      Float @default(9)
  igstPercent      Float @default(0)
  tdsPercent       Float @default(2)
  retentionPercent Float @default(0)
  
  // Calculated Tax Amounts
  cgstAmount      Float @default(0)
  sgstAmount      Float @default(0)
  igstAmount      Float @default(0)
  tdsAmount       Float @default(0)
  retentionAmount Float @default(0)
  
  // Payment Information
  advancePaid   Float @default(0)
  previousBills Float @default(0)
  
  // Totals
  subtotal       Float // Sum of all items
  grossAmount    Float // Subtotal + additional charges
  totalWithTax   Float // Gross + taxes
  netPayable     Float // Final amount after deductions
  
  // Additional Information
  remarks            String?
  termsAndConditions String?
  
  // Status & Metadata
  status     BillStatus @default(DRAFT)
  companyId  String
  createdBy  String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  creator   User?      @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  items     BillItem[]
  
  @@index([companyId])
  @@index([projectId])
  @@index([billId])
  @@index([billDate])
  @@index([status])
}

model BillItem {
  id          Int      @id @default(autoincrement())
  billId      Int
  sno         Int      // Serial number for ordering
  description String
  unit        String   // Nos, Sqft, Sqm, etc.
  quantity    Float
  rate        Float
  amount      Float    // quantity * rate
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  @@index([billId])
  @@index([sno])
}

enum BillStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

model LabourPayment {
  id        Int      @id @default(autoincrement())
  labourId  Int
  amount    Float
  date      DateTime
  remarks   String?  // Optional: add notes about the payment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  labour    Labour   @relation(fields: [labourId], references: [id], onDelete: Cascade)
  
  @@index([labourId])
  @@index([date])
}

enum ProjectMaterialStatus {
  ACTIVE
  COMPLETED
  NOT_USED
}

enum MaterialRequestType {
  GLOBAL
  PROJECT
  PROJECT_MATERIAL
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SUCCESS
  ERROR
  INFO
  WARNING
}

enum Role {
  Admin
  Site_Engineer
}

enum ProjectStatus {
  PENDING
  ONGOING
  COMPLETED
}

enum TransactionType {
  INCOME
  EXPENSE
  BUDGET
}