generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  name               String
  email              String              @unique
  password           String
  companyId          String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  role               String
  phoneNumber        String              @default("")
  city               String              @default("")
  address            String              @default("")
  uploadedFiles      File[]
  projectAssignments ProjectAssignment[]
  company            Company?            @relation(fields: [companyId], references: [id])

  @@index([phoneNumber])
}

model Project {
  id                     Int                      @id @default(autoincrement())
  name                   String
  description            String?
  companyId              String
  startDate              DateTime?
  endDate                DateTime?
  status                 ProjectStatus            @default(ONGOING)
  createdAt              DateTime                 @default(now())
  budget                 Float?
  clientName             String
  projectId              String                   @unique
  projectType            String
  assignedEngineerId     Int?
  location               String?
  dueDate                DateTime?
  quotationAmount        Float?
  actualProgress         Int                      @default(0)
  contracts              Contract[]
  files                  File[]
  finances               FinancialTransaction[]
  labours                Labour[]
  materialRequests       MaterialRequest[]
  materialUsages         MaterialUsage[]
  assignedEngineer       Engineer?                @relation(fields: [assignedEngineerId], references: [id])
  company                Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignments            ProjectAssignment[]
  expenses               ProjectExpense[]
  projectMaterials       ProjectMaterial[]
  daily_progress_updates daily_progress_updates[]

  @@index([companyId])
  @@index([projectId])
  @@index([status])
  @@index([assignedEngineerId])
}

model ProjectExpense {
  id        Int      @id @default(autoincrement())
  projectId Int
  category  String
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
}

model ProjectAssignment {
  id         Int      @id @default(autoincrement())
  projectId  Int
  userId     String
  assignedAt DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Material {
  id               Int               @id @default(autoincrement())
  name             String
  type             String?
  unit             String
  companyId        String
  createdAt        DateTime          @default(now())
  category         String
  defaultRate      Float?
  description      String?
  materialId       String            @unique
  updatedAt        DateTime          @updatedAt
  vendor           String?
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requests         MaterialRequest[]
  usages           MaterialUsage[]
  projectMaterials ProjectMaterial[]

  @@index([companyId])
  @@index([materialId])
  @@index([category])
}

model ProjectMaterial {
  id         Int                   @id @default(autoincrement())
  projectId  Int
  materialId Int
  assigned   Float
  used       Float                 @default(0)
  status     ProjectMaterialStatus @default(ACTIVE)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  material   Material              @relation(fields: [materialId], references: [id], onDelete: Cascade)
  project    Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, materialId])
  @@index([projectId])
  @@index([materialId])
  @@index([status])
}

model MaterialUsage {
  id         Int      @id @default(autoincrement())
  materialId Int
  projectId  Int
  quantity   Float
  date       DateTime @default(now())
  remarks    String?
  engineerId Int
  engineer   Engineer @relation(fields: [engineerId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([materialId])
  @@index([engineerId])
  @@index([date])
}

model MaterialRequest {
  id              Int                 @id @default(autoincrement())
  requestId       String              @unique
  name            String
  category        String
  unit            String
  defaultRate     Float
  vendor          String?
  description     String?
  type            MaterialRequestType
  projectId       Int?
  materialId      Int?
  quantity        Float?
  status          RequestStatus       @default(PENDING)
  requestDate     DateTime            @default(now())
  reviewDate      DateTime?
  approvalNotes   String?
  rejectionReason String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  employeeId      Int
  reviewedBy      Int?
  employee        Engineer            @relation("EmployeeRequests", fields: [employeeId], references: [id], onDelete: Cascade)
  material        Material?           @relation(fields: [materialId], references: [id])
  project         Project?            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer        Engineer?           @relation("ReviewedRequests", fields: [reviewedBy], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([type])
  @@index([projectId])
  @@index([requestDate])
}

model Notification {
  id         Int              @id @default(autoincrement())
  message    String
  type       NotificationType
  read       Boolean          @default(false)
  date       DateTime         @default(now())
  engineerId Int
  engineer   Engineer         @relation(fields: [engineerId], references: [id], onDelete: Cascade)

  @@index([engineerId])
  @@index([read])
  @@index([date])
}

model Contract {
  id             Int      @id @default(autoincrement())
  projectId      Int
  contractorName String
  details        String?
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime @default(now())
  contactNumber  String
  contractAmount Float
  updatedAt      DateTime @updatedAt
  workStatus     String
  paidAmount     Float    @default(0)
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model FinancialTransaction {
  id          Int             @id @default(autoincrement())
  projectId   Int
  type        TransactionType
  amount      Float
  description String?
  date        DateTime        @default(now())
  category    String?
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([category])
  @@index([date])
}

model File {
  id                   Int       @id @default(autoincrement())
  projectId            Int
  uploadedBy           String?
  fileUrl              String
  fileName             String?
  uploadedAt           DateTime  @default(now())
  documentType         String?
  fileSize             Int?
  uploadedByEngineerId Int?
  project              Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  engineer             Engineer? @relation(fields: [uploadedByEngineerId], references: [id], onDelete: Cascade)
  user                 User?     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
  @@index([uploadedByEngineerId])
}

model Company {
  id        String     @id @default(uuid())
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  labours   Labour[]
  materials Material[]
  projects  Project[]
  users     User[]
  engineers Engineer[]

  @@map("companies")
}

model Engineer {
  id                     Int                      @id @default(autoincrement())
  name                   String
  empId                  String
  phone                  String
  alternatePhone         String?
  address                String
  profileImage           String?
  companyId              String
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  password               String?
  username               String?
  plainPassword          String?
  uploadedFiles          File[]
  materialRequests       MaterialRequest[]        @relation("EmployeeRequests")
  reviewedRequests       MaterialRequest[]        @relation("ReviewedRequests")
  materialUsages         MaterialUsage[]
  notifications          Notification[]
  projects               Project[]
  daily_progress_updates daily_progress_updates[]
  company                Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([empId, companyId])
  @@unique([username, companyId])
  @@index([companyId])
  @@index([username])
  @@map("engineers")
}

model Labour {
  id        Int             @id @default(autoincrement())
  name      String
  phone     String
  address   String?
  companyId String
  projectId Int?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project?        @relation(fields: [projectId], references: [id])
  payments  LabourPayment[]

  @@index([companyId])
  @@index([projectId])
  @@index([phone])
}

model LabourPayment {
  id        Int      @id @default(autoincrement())
  labourId  Int
  amount    Float
  date      DateTime
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  labour    Labour   @relation(fields: [labourId], references: [id], onDelete: Cascade)

  @@index([labourId])
  @@index([date])
}

model daily_progress_updates {
  id         Int      @id @default(autoincrement())
  projectId  Int
  engineerId Int
  message    String
  workDone   String?
  challenges String?
  nextSteps  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now())
  engineers  Engineer @relation(fields: [engineerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([createdAt])
  @@index([engineerId])
  @@index([projectId])
}

enum ProjectMaterialStatus {
  ACTIVE
  COMPLETED
  NOT_USED
}

enum MaterialRequestType {
  GLOBAL
  PROJECT
  PROJECT_MATERIAL
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SUCCESS
  ERROR
  INFO
  WARNING
}

enum Role {
  Admin
  Site_Engineer
}

enum ProjectStatus {
  PENDING
  ONGOING
  COMPLETED
}

enum TransactionType {
  INCOME
  EXPENSE
  BUDGET
}
